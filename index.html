<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smooth Karaoke Animation</title>
  <style>
    html, body {
      margin: 0;
      background: black;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: Arial, sans-serif;
    }

    canvas {
      background: black;
    }

    button {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <canvas id="karaokeCanvas" width="720" height="1280"></canvas>
  <button id="downloadBtn">Click Me</button>

  <script>
    const canvas = document.getElementById("karaokeCanvas");
    const ctx = canvas.getContext("2d");
    const downloadBtn = document.getElementById("downloadBtn");

    const sentence = "Discover 10 ways to start a business without money";
    const words = sentence.split(" ");
    const fontSize = 64;
    const durationPerWord = 1000; // ms
    const maxVisible = 3;

    ctx.font = `${fontSize}px Arial`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    let animationFrameId;
    let animationStartTime;
    let recordedChunks = [];
    let mediaRecorder;

    function drawWords(currentTime) {
      const elapsed = currentTime - animationStartTime;
      const totalDuration = words.length * durationPerWord;

      if (elapsed >= totalDuration) {
        cancelAnimationFrame(animationFrameId);
        mediaRecorder.stop();
        return;
      }

      const currentWordFloatIndex = elapsed / durationPerWord;
      const wordIndex = Math.floor(currentWordFloatIndex);
      const progress = currentWordFloatIndex - wordIndex;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;

      const visibleStart = Math.max(0, wordIndex - 1);
      const visibleEnd = Math.min(words.length, visibleStart + maxVisible);
      const visibleWords = words.slice(visibleStart, visibleEnd);

      const spacing = 40;
      const wordWidths = visibleWords.map(w => ctx.measureText(w).width);
      const totalWidth = wordWidths.reduce((a, b) => a + b, 0) + spacing * (visibleWords.length - 1);
      let startX = centerX - totalWidth / 2;

      visibleWords.forEach((word, i) => {
        const actualIndex = visibleStart + i;
        const wordX = startX + wordWidths.slice(0, i).reduce((a, b) => a + b + spacing, 0);

        let opacity = 1.0;
        if (actualIndex === wordIndex) {
          // Fade in highlight
          ctx.save();
          ctx.lineWidth = 5;
          ctx.strokeStyle = `rgba(255,255,255,${1 - progress})`;
          ctx.strokeText(word, wordX, centerY);

          ctx.fillStyle = `rgba(255,255,0,${progress})`;
          ctx.fillText(word, wordX, centerY);
          ctx.restore();
        } else if (actualIndex === wordIndex - 1) {
          // Fade out previous highlight
          ctx.save();
          ctx.lineWidth = 4;
          ctx.strokeStyle = "white";
          ctx.strokeText(word, wordX, centerY);

          ctx.fillStyle = `rgba(255,255,255,${1 - progress})`;
          ctx.fillText(word, wordX, centerY);
          ctx.restore();
        } else {
          // Normal word
          ctx.save();
          ctx.lineWidth = 3;
          ctx.strokeStyle = "white";
          ctx.strokeText(word, wordX, centerY);

          ctx.fillStyle = "white";
          ctx.fillText(word, wordX, centerY);
          ctx.restore();
        }
      });

      animationFrameId = requestAnimationFrame(drawWords);
    }

    function startAnimation() {
      const stream = canvas.captureStream(30);
      mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

      recordedChunks = [];

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "karaoke_smooth.webm";
        a.click();
        URL.revokeObjectURL(url);
      };

      animationStartTime = performance.now();
      mediaRecorder.start();
      animationFrameId = requestAnimationFrame(drawWords);
    }

    downloadBtn.addEventListener("click", () => {
      startAnimation();
    });
  </script>
</body>
</html>