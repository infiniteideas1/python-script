<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Finance Quote Karaoke</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: pink;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    canvas {
      background: navy;
    }

    button {
      margin-top: 20px;
      padding: 14px 28px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    @font-face {
      font-family: 'Impact';
      src: local('Impact'), local('Arial Black'), sans-serif;
    }
  </style>
</head>
<body>
  <canvas id="karaokeCanvas" width="720" height="1280"></canvas>
  <button id="downloadBtn">Click Me</button>

  <script>
    const canvas = document.getElementById("karaokeCanvas");
    const ctx = canvas.getContext("2d");
    const downloadBtn = document.getElementById("downloadBtn");

    const quote = "INVEST IN YOUR\nFUTURE NOT YOUR FEARS";
    const fontFamily = "Impact";
    const fontSize = 80;
    const fontColor = "white";
    const karaokeColor = "yellow";
    const lineSpacing = 1.4;
    const fadeDuration = 1000;
    const karaokeDuration = 4000;
    const quoteDuration = karaokeDuration + fadeDuration + 1000;

    const lines = quote.split("\n");
    let animationStartTime;
    let mediaRecorder;
    let recordedChunks = [];

    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    function fitFontSize(textLines, maxWidth, baseSize) {
      let size = baseSize;
      ctx.font = `${size}px ${fontFamily}`;
      const longestLine = textLines.reduce((a, b) => a.length > b.length ? a : b);
      while (ctx.measureText(longestLine).width > maxWidth && size > 20) {
        size -= 2;
        ctx.font = `${size}px ${fontFamily}`;
      }
      return size;
    }

    function drawKaraokeQuote(timeElapsed) {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;

      const fadeProgress = Math.min(timeElapsed / fadeDuration, 1);
      const charProgress = Math.min((timeElapsed - fadeDuration) / karaokeDuration, 1);

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const fittedSize = fitFontSize(lines, canvas.width - 80, fontSize);
      ctx.font = `bold ${fittedSize}px ${fontFamily}`;

      const totalHeight = lines.length * fittedSize * lineSpacing;
      const startY = centerY - totalHeight / 2 + fittedSize / 2;

      ctx.save();
      ctx.globalAlpha = fadeProgress;

      lines.forEach((line, i) => {
        const y = startY + i * fittedSize * lineSpacing;

        // Draw full outline and base
        ctx.lineWidth = 4;
        ctx.strokeStyle = "black";
        ctx.strokeText(line, centerX, y);
        ctx.fillStyle = fontColor;
        ctx.fillText(line, centerX, y);

        // Karaoke highlight by character
        const totalChars = line.length;
        const highlightCount = Math.floor(charProgress * totalChars);
        if (highlightCount > 0) {
          const karaokeText = line.slice(0, highlightCount);
          ctx.save();
          ctx.fillStyle = karaokeColor;
          ctx.strokeStyle = "black";
          ctx.strokeText(karaokeText, centerX, y);
          ctx.fillText(karaokeText, centerX, y);
          ctx.restore();
        }
      });

      ctx.restore();
    }

    function animate(timestamp) {
      const timeElapsed = timestamp - animationStartTime;

      drawKaraokeQuote(timeElapsed);

      if (timeElapsed < quoteDuration) {
        requestAnimationFrame(animate);
      } else {
        mediaRecorder.stop();
      }
    }

    function startRecording() {
      const stream = canvas.captureStream(30);
      mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

      recordedChunks = [];

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "finance_quote_karaoke.webm";
        a.click();
        URL.revokeObjectURL(url);
      };

      mediaRecorder.start();
      animationStartTime = performance.now();
      requestAnimationFrame(animate);
    }

    downloadBtn.addEventListener("click", () => {
      startRecording();
    });
  </script>
</body>
</html>